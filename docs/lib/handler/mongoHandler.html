<!DOCTYPE html>

<html>
<head>
  <title>mongoHandler.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>mongoHandler.js</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="comment">/*
 * Copyright (c) 2014, Tidepool Project
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this
 * list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice, this
 * list of conditions and the following disclaimer in the documentation and/or other
 * materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */</span>
 
<span class="string">'use strict'</span>;

<span class="keyword">var</span> mongojs = require(<span class="string">'mongojs'</span>),
    messagesCollection,
    messagesCollectionName = <span class="string">'messages'</span>,
    log = require(<span class="string">'../log.js'</span>)(<span class="string">'mongoHandler.js'</span>);

<span class="comment">/*
    Handler CRUD opertaions via Mongo instance
*/</span>
<span class="keyword">var</span> mongoHandler = <span class="function"><span class="keyword">function</span><span class="params">(connectionString)</span> {</span>

    <span class="keyword">var</span> dbInstance = mongojs(connectionString, [messagesCollectionName]);
    messagesCollection = dbInstance.collection(messagesCollectionName);

    <span class="keyword">return</span> {
        createMessage : handleCreateMessage,
        getMessage : handleGetMessage,
        getAllMessages : handleGetAllMessages
    };
};

<span class="comment">/*
    With mongo we change to use the id field
*/</span>
<span class="function"><span class="keyword">function</span> <span class="title">setMessage</span><span class="params">(doc)</span>{</span>

    <span class="keyword">var</span> message = {
        id : doc._id,
        userid : doc.userid,
        groupid : doc.groupid,
        timestamp : doc.timestamp,
        messagetext : doc.messagetext
    };

    <span class="keyword">return</span> message;
}

<span class="comment">/*
    Is the given Id valid for Mongo
*/</span>
<span class="function"><span class="keyword">function</span> <span class="title">objectIdIsValid</span><span class="params">(idString)</span>{</span>
    <span class="keyword">try</span>{
        mongojs.ObjectId(idString);
    }<span class="keyword">catch</span>(error){
        log.warn(<span class="string">'given[%j] is an invalid mongojs.ObjectId.'</span>,idString);
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">return</span> <span class="literal">true</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">handleCreateMessage</span> <span class="params">(message,callback)</span> {</span>
    log.debug(<span class="string">'Adding message[%j]'</span>, message);

    messagesCollection.save(message, <span class="function"><span class="keyword">function</span><span class="params">(error, doc)</span> {</span>
        <span class="keyword">if</span> (error) {
            <span class="keyword">return</span> callback(error,<span class="literal">null</span>);
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> callback(<span class="literal">null</span>,doc._id);
        }
    });

}

<span class="function"><span class="keyword">function</span> <span class="title">handleGetMessage</span><span class="params">(messageId,callback)</span> {</span>
    
    log.debug(<span class="string">'Finding message for messageId[%s]'</span>, messageId);

    <span class="keyword">if</span>(objectIdIsValid(messageId)){

        messagesCollection.findOne(
            { _id : mongojs.ObjectId(messageId)},
            <span class="function"><span class="keyword">function</span><span class="params">(error, doc)</span> {</span>
            <span class="keyword">if</span> (error) {
                <span class="keyword">return</span> callback(error,<span class="literal">null</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span>(doc){         
                <span class="keyword">return</span> callback(<span class="literal">null</span>,setMessage(doc));
            }
            <span class="keyword">return</span> callback(<span class="literal">null</span>,<span class="literal">null</span>);
        });
    }<span class="keyword">else</span>{
        <span class="keyword">return</span> callback(<span class="literal">null</span>,<span class="literal">null</span>);
    }
}

<span class="function"><span class="keyword">function</span> <span class="title">handleGetAllMessages</span><span class="params">(groupId, startTime, endTime, callback)</span> {</span>

    log.debug(<span class="string">'Finding all messages for group[%s] from[%s] to[%s]'</span>, groupId, startTime, endTime);   

    <span class="keyword">var</span> timeQueryOptions;

    <span class="keyword">if</span>(endTime){</pre></div>
        
      
        
        <p>using mongojs notation for query paramaeters &gt;= &lt;=</p>

        
          <div class='highlight'><pre>        timeQueryOptions = { $gte: startTime, $lte: endTime };
    }<span class="keyword">else</span>{
        timeQueryOptions = { $gte: startTime};
    }

    messagesCollection.find(
        { timestamp : timeQueryOptions, groupid : groupId }, 
        <span class="function"><span class="keyword">function</span><span class="params">(error,doc)</span>{</span>
            <span class="keyword">if</span> (error) {
                <span class="keyword">return</span> callback(error,<span class="literal">null</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (doc &amp;&amp; doc.length&gt;<span class="number">0</span>){
                <span class="keyword">var</span> messages = [];

                doc.forEach(<span class="function"><span class="keyword">function</span><span class="params">(foundMessage)</span> {</span>
                    messages.push(setMessage(foundMessage));
                });
                <span class="keyword">return</span> callback(<span class="literal">null</span>, messages);
            }
            <span class="keyword">return</span> callback(<span class="literal">null</span>,<span class="literal">null</span>);
        });
    
}

module.exports = mongoHandler;</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
