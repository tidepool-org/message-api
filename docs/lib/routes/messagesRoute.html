<!DOCTYPE html>

<html>
<head>
  <title>messagesRoute.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>messagesRoute.js</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="comment">/*
 * Copyright (c) 2014, Tidepool Project
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this
 * list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice, this
 * list of conditions and the following disclaimer in the documentation and/or other
 * materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */</span>
 
<span class="string">'use strict'</span>;

<span class="keyword">var</span> log = require(<span class="string">'../log.js'</span>)(<span class="string">'messagesRoute.js'</span>);

<span class="comment">/*
    Mongo instance of messaging-api CRUD operations
*/</span>
module.exports = <span class="function"><span class="keyword">function</span><span class="params">(crudHandler)</span> {</span>


    <span class="comment">/*
        HELPER METHODS
    */</span></pre></div>
        
      
        
        <p>Ensure all the details are valid before we save a new message</p>

        
          <div class='highlight'><pre>    <span class="keyword">var</span> messageToSaveIsValid = <span class="function"><span class="keyword">function</span><span class="params">(message)</span>{</span>

        <span class="keyword">if</span> (message.userid !== <span class="string">''</span> &amp;&amp;
            message.groupid !== <span class="string">''</span> &amp;&amp;
            message.timestamp !== <span class="string">''</span> &amp;&amp;
            message.messagetext !== <span class="string">''</span>){
            <span class="keyword">return</span> <span class="literal">true</span>;
        } <span class="keyword">else</span> {
            log.warn(<span class="string">'message format[%j] is invalid.'</span>,message);
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
    };

    <span class="comment">/*
       API HEALTH CHECK END-POINTS
    */</span></pre></div>
        
      
        
        <p>status check for the API to let us know all is good or if not what is down</p>

        
          <div class='highlight'><pre>    <span class="keyword">var</span> status = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
        log.debug(<span class="string">'status: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);
        
        res.send(<span class="number">501</span>);

        <span class="keyword">return</span> next();
    };

    <span class="comment">/*
        API STANDARD END-POINTS
    */</span>

    <span class="keyword">var</span> findById = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
        log.debug(<span class="string">'findById: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);
        
        res.setHeader(<span class="string">'content-type'</span>, <span class="string">'application/json'</span>);
        <span class="keyword">var</span> messageId = req.params.msgid;

        crudHandler.getMessage(messageId, <span class="function"><span class="keyword">function</span><span class="params">(error,message)</span>{</span>
            <span class="keyword">if</span> (error){
                log.error(error, <span class="string">'Error getting message[%s]'</span>, messageId);
                res.send(<span class="number">500</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span>(message) {   
                res.send(<span class="number">200</span>, {message : message});
            }<span class="keyword">else</span>{
                log.info(<span class="string">'message not found for id[%s]'</span>,messageId);
                res.send(<span class="number">204</span>);
            }
        });

        <span class="keyword">return</span> next();
        
    };

    <span class="keyword">var</span> findAllById = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
        log.debug(<span class="string">'findAllById: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);
        res.setHeader(<span class="string">'content-type'</span>, <span class="string">'application/json'</span>);

        <span class="keyword">var</span> groupId = req.params.groupid;
        <span class="keyword">var</span> start = req.params.starttime;
        <span class="keyword">var</span> end = req.params.endtime;

        crudHandler.getAllMessages(groupId, start, end, <span class="function"><span class="keyword">function</span><span class="params">(error,messages)</span>{</span>
            <span class="keyword">if</span> (error){
                log.error(error, <span class="string">'Error getting messages for group[%s] from[%s] to[%s]'</span>, groupId, start, end);
                res.send(<span class="number">500</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span>(messages.length &gt; <span class="number">0</span>) {
                res.send(<span class="number">200</span>,{messages : messages});
            }<span class="keyword">else</span>{
                log.info(<span class="string">'messages not found for id[%s]'</span>,groupId);
                res.send(<span class="number">204</span>);
            }
        });

        <span class="keyword">return</span> next();
        
    };

    <span class="keyword">var</span> add = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
        log.debug(<span class="string">'add: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);

        <span class="keyword">var</span> message = req.params.message;

        <span class="keyword">if</span>(messageToSaveIsValid(message)){

            crudHandler.createMessage(message,<span class="function"><span class="keyword">function</span><span class="params">(error,messageId)</span>{</span>
                <span class="keyword">if</span>(error){
                    log.error(error, <span class="string">'Error adding message[%j]'</span>, message);
                    res.send(<span class="number">500</span>);
                }<span class="keyword">else</span>{
                    res.send(<span class="number">201</span>,{Id : messageId});
                }

            });

        }<span class="keyword">else</span>{
            res.send(<span class="number">400</span>);
        }
        <span class="keyword">return</span> next();
    };

    <span class="keyword">return</span> {
        status: status,
        add: add,
        findAllById: findAllById,
        findById: findById
    };
};</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
